---
import MeldekortEtterregistrering from "@src/components/MeldekortEtterregistrering";
import MeldekortPending from "@src/components/MeldekortPending";
import MeldekortReady from "@src/components/MeldekortReady";
import type { Language } from "@src/language/types";
import styles from "@src/styles/index.module.css";
import { logger } from "@src/utils/logger";
import "@src/styles/aksel.css";
import { isLocal } from "../../utils/environment";
import { hentMeldekortDataFraApi, prosesserMeldekortDataFraApi } from "@src/utils/meldekortData.ts";
import {
  MELDEKORT_API_AUDIENCE,
  MELDEKORT_API_URL,
  MELDEKORTREGISTER_AUDIENCE,
  MELDEKORTREGISTER_URL
} from "astro:env/server";

let meldekortDataFraArena;
let meldekortDataFraDp;

try {
  meldekortDataFraArena = await hentMeldekortDataFraApi(Astro.locals.token, MELDEKORT_API_AUDIENCE || "", MELDEKORT_API_URL || "");
  meldekortDataFraDp = await hentMeldekortDataFraApi(Astro.locals.token, MELDEKORTREGISTER_AUDIENCE || "", MELDEKORTREGISTER_URL || "");
} catch (error) {
  logger.error("Error fetching meldekortdata: " + error);
  return new Response("Internal Server Error", { status: 503 });
}

const arenaData = prosesserMeldekortDataFraApi(meldekortDataFraArena);
const dpData = prosesserMeldekortDataFraApi(meldekortDataFraDp);
const language = Astro.currentLocale as Language;
---

{isLocal &&
<meta charset="UTF-8"/>}
<section class="meldekort-mikrofrontend">
  <div class={styles.microfrontend}>
    <MeldekortEtterregistrering language={language} meldekort={arenaData.meldekortData} dagpenger={false}/>
    {arenaData.isPendingForInnsending ? <MeldekortPending language={language} meldekort={arenaData.meldekortData} dagpenger={false}/> : null}
    {arenaData.isReadyForInnsending ? <MeldekortReady language={language} meldekort={arenaData.meldekortData} dagpenger={false}/> : null}
    <MeldekortEtterregistrering language={language} meldekort={dpData.meldekortData} dagpenger={true}/>
    {dpData.isPendingForInnsending ? <MeldekortPending language={language} meldekort={dpData.meldekortData} dagpenger={true}/> : null}
    {dpData.isReadyForInnsending ? <MeldekortReady language={language} meldekort={dpData.meldekortData} dagpenger={true}/> : null}
  </div>
</section>
